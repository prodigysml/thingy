name: "CI Build"
on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      MOZBUILD_STATE_PATH: /home/runner/.mozbuild
      SCCACHE_CACHE_SIZE: 5G
      SCCACHE_DIR: /home/runner/.cache/sccache
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Sync upstream
        run: |
          git remote add upstream https://github.com/mozilla-firefox/firefox.git
          git fetch upstream main --depth 1
          git reset --hard upstream/main

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean

      - name: Add swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 16G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Restore mozbuild toolchains
        uses: actions/cache/restore@v4
        with:
          path: ~/.mozbuild
          key: mozbuild-${{ runner.os }}-${{ hashFiles('python/mozboot/**') }}
          restore-keys: mozbuild-${{ runner.os }}-

      - name: Restore sccache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/sccache
          key: sccache-${{ runner.os }}-${{ github.run_id }}
          restore-keys: sccache-${{ runner.os }}-

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-venv openssl
          cat > .mozconfig <<'MOZCONFIG'
          mk_add_options MOZ_PARALLEL_BUILD=8
          ac_add_options --enable-optimize
          ac_add_options --disable-debug
          ac_add_options --disable-tests
          ac_add_options --disable-crashreporter
          ac_add_options --disable-updater
          ac_add_options --enable-linker=lld
          ac_add_options --with-ccache=sccache
          MOZCONFIG
          yes '' | ./mach bootstrap --application-choice=browser

      - name: Install CodeQL
        run: |
          LATEST=$(gh api /repos/github/codeql-action/releases/latest --jq .tag_name)
          gh release download "$LATEST" --repo github/codeql-action --pattern 'codeql-bundle-linux64.tar.gz' --dir /tmp
          tar xzf /tmp/codeql-bundle-linux64.tar.gz -C /opt
          rm /tmp/codeql-bundle-linux64.tar.gz
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Full build with sccache
        run: ./mach build

      - name: Save sccache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/sccache
          key: sccache-${{ runner.os }}-${{ github.run_id }}

      - name: Save mozbuild toolchains
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ~/.mozbuild
          key: mozbuild-${{ runner.os }}-${{ hashFiles('python/mozboot/**') }}

      - name: Touch sources for CodeQL incremental rebuild
        run: |
          OBJ_DIR=$(ls -d obj-* 2>/dev/null | head -1)

          find \
            js/src \
            dom/ipc dom/media dom/indexedDB dom/canvas dom/html \
            dom/base dom/bindings dom/workers dom/serviceworkers \
            dom/webidl dom/fetch dom/file dom/midi \
            gfx/layers gfx/2d gfx/thebes gfx/wr gfx/ots \
            gfx/graphite2 gfx/harfbuzz gfx/skia gfx/gl \
            ipc/glue ipc/chromium \
            image \
            media/gmp-clearkey media/ffvpx media/libvpx \
            media/libaom media/libpng media/libjpeg \
            accessible/ipc accessible/generic accessible/base \
            parser/html parser/xml \
            netwerk \
            security/manager security/sandbox security/certverifier \
            xpcom/io xpcom/threads xpcom/base xpcom/ds xpcom/string \
            mfbt mozglue \
            layout/generic layout/base layout/painting layout/style \
            storage \
            widget \
            toolkit/components/telemetry toolkit/components/extensions \
            tools/profiler \
            intl/lwbrk intl/unicharutil \
            -name '*.cpp' -exec touch {} + 2>/dev/null

          if [ -n "$OBJ_DIR" ]; then
            find "$OBJ_DIR/ipc/ipdl" -name '*.cpp' -exec touch {} + 2>/dev/null
            find "$OBJ_DIR/dom" -name '*Binding.cpp' -exec touch {} + 2>/dev/null
          fi

          TOUCHED=$(find . -name '*.cpp' -newer .mozconfig | wc -l)
          echo "Touched $TOUCHED source files for CodeQL rebuild"

      - name: CodeQL traced incremental rebuild
        run: |
          /opt/codeql/codeql database init --language=cpp --source-root=. /home/runner/codeql-db
          /opt/codeql/codeql database trace-command /home/runner/codeql-db -- ./mach build
        env:
          SCCACHE_DISABLE: "1"

      - name: Finalize database
        run: |
          /opt/codeql/codeql database finalize \
            --threads=1 \
            --ram=5120 \
            /home/runner/codeql-db

      - name: Package output
        run: |
          tar czf /tmp/output.tar.gz -C /home/runner codeql-db
          openssl enc -aes-256-cbc -salt -pbkdf2 -in /tmp/output.tar.gz -out /tmp/output.tar.gz.enc -pass pass:"${{ secrets.DB_KEY }}"
          rm /tmp/output.tar.gz

      - name: Upload output
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_id }}
          path: /tmp/output.tar.gz.enc
          retention-days: 7
