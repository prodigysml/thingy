name: "CI Build"
on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      MOZBUILD_STATE_PATH: /home/runner/.mozbuild
      SCCACHE_CACHE_SIZE: 5G
      SCCACHE_DIR: /home/runner/.cache/sccache
    permissions:
      actions: read
      contents: read
    outputs:
      obj-dir: ${{ steps.find-obj.outputs.obj-dir }}
    steps:
      - uses: actions/checkout@v4

      - name: Sync upstream
        run: |
          git remote add upstream https://github.com/mozilla-firefox/firefox.git
          git fetch upstream main --depth 1
          git reset --hard upstream/main

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean

      - name: Restore mozbuild toolchains
        uses: actions/cache/restore@v4
        with:
          path: ~/.mozbuild
          key: mozbuild-${{ runner.os }}-${{ hashFiles('python/mozboot/**') }}
          restore-keys: mozbuild-${{ runner.os }}-

      - name: Restore sccache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/sccache
          key: sccache-${{ runner.os }}-${{ github.run_id }}
          restore-keys: sccache-${{ runner.os }}-

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-venv openssl
          cat > .mozconfig <<'MOZCONFIG'
          mk_add_options MOZ_PARALLEL_BUILD=4
          ac_add_options --enable-optimize
          ac_add_options --disable-debug
          ac_add_options --disable-tests
          ac_add_options --disable-crashreporter
          ac_add_options --disable-updater
          ac_add_options --enable-linker=lld
          ac_add_options --with-ccache=sccache
          MOZCONFIG
          yes '' | ./mach bootstrap --application-choice=browser

      - name: Full build with sccache
        run: ./mach build

      - name: Find obj dir
        id: find-obj
        run: echo "obj-dir=$(ls -d obj-* | head -1)" >> "$GITHUB_OUTPUT"

      - name: Save sccache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/sccache
          key: sccache-${{ runner.os }}-${{ github.run_id }}

      - name: Save mozbuild toolchains
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ~/.mozbuild
          key: mozbuild-${{ runner.os }}-${{ hashFiles('python/mozboot/**') }}

      - name: Package build artifacts for CodeQL job
        run: |
          OBJ_DIR="${{ steps.find-obj.outputs.obj-dir }}"
          echo "Packaging $OBJ_DIR for next job..."
          df -h /

          # Keep .o files! Job 2 only deletes .o for targeted directories.
          # Without the rest, mach build would try to recompile everything.
          tar cf /tmp/objdir.tar \
            --exclude='dist/bin' \
            --exclude='*.pyc' \
            --exclude='__pycache__' \
            "$OBJ_DIR" .mozconfig

          ls -lh /tmp/objdir.tar
          echo "Compressed size:"
          zstd -1 /tmp/objdir.tar -o /tmp/objdir.tar.zst
          ls -lh /tmp/objdir.tar.zst
          rm /tmp/objdir.tar

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: objdir-${{ github.run_id }}
          path: /tmp/objdir.tar.zst
          retention-days: 1
          compression-level: 0

  codeql:
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 360
    env:
      MOZBUILD_STATE_PATH: /home/runner/.mozbuild
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Sync upstream
        run: |
          git remote add upstream https://github.com/mozilla-firefox/firefox.git
          git fetch upstream main --depth 1
          git reset --hard upstream/main

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /usr/local/share/powershell /usr/local/share/chromium \
            /usr/local/lib/node_modules /opt/hostedtoolcache \
            /usr/share/swift /usr/share/miniconda /usr/local/julia* \
            /usr/local/share/edge_driver /usr/local/share/gecko_driver \
            /usr/share/az_* /opt/microsoft /usr/share/gradle* \
            /usr/share/apache-maven* /usr/share/sbt
          sudo apt-get clean
          docker rmi $(docker image ls -q) 2>/dev/null || true
          echo "Disk after cleanup:"
          df -h /

      - name: Add swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 16G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Restore mozbuild toolchains
        uses: actions/cache/restore@v4
        with:
          path: ~/.mozbuild
          key: mozbuild-${{ runner.os }}-${{ hashFiles('python/mozboot/**') }}
          restore-keys: mozbuild-${{ runner.os }}-

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-venv openssl
          cat > .mozconfig <<'MOZCONFIG'
          mk_add_options MOZ_PARALLEL_BUILD=4
          mk_add_options AUTOCLOBBER=1
          ac_add_options --enable-optimize
          ac_add_options --disable-debug
          ac_add_options --disable-tests
          ac_add_options --disable-crashreporter
          ac_add_options --disable-updater
          ac_add_options --enable-linker=lld
          MOZCONFIG
          yes '' | ./mach bootstrap --application-choice=browser

      - name: Install CodeQL
        run: |
          LATEST=$(gh api /repos/github/codeql-action/releases/latest --jq .tag_name)
          gh release download "$LATEST" --repo github/codeql-action --pattern 'codeql-bundle-linux64.tar.gz' --dir /tmp
          tar xzf /tmp/codeql-bundle-linux64.tar.gz -C /opt
          rm /tmp/codeql-bundle-linux64.tar.gz
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: objdir-${{ github.run_id }}
          path: /tmp

      - name: Restore build state and delete targeted .o files
        run: |
          echo "Extracting build artifacts..."
          zstd -d /tmp/objdir.tar.zst -o /tmp/objdir.tar
          tar xf /tmp/objdir.tar
          rm /tmp/objdir.tar /tmp/objdir.tar.zst

          OBJ_DIR=$(ls -d obj-* 2>/dev/null | head -1)
          echo "Build directory: $OBJ_DIR"

          touch "$OBJ_DIR/CLOBBER"

          # Only delete .o files for security-relevant directories.
          # The rest stay intact so mach build skips them.
          TARGET_DIRS="
            dom/ipc dom/media dom/indexedDB dom/canvas dom/cache
            dom/base dom/bindings dom/fetch dom/file dom/midi
            ipc/glue ipc/ipdl
            gfx/layers gfx/2d gfx/thebes
            image
            media/gmp-clearkey
            accessible/ipc
            xpcom/io xpcom/threads xpcom/base
            netwerk/protocol netwerk/base netwerk/cache2
            security/manager
            mfbt
          "
          DELETED=0
          for dir in $TARGET_DIRS; do
            if [ -d "$OBJ_DIR/$dir" ]; then
              count=$(find "$OBJ_DIR/$dir" -name '*.o' | wc -l)
              find "$OBJ_DIR/$dir" -name '*.o' -delete
              echo "  Deleted $count .o files from $OBJ_DIR/$dir"
              DELETED=$((DELETED + count))
            fi
          done
          echo "Total deleted: $DELETED object files"

          df -h /
          free -h

      - name: CodeQL traced rebuild
        run: |
          /opt/codeql/codeql database init \
            --language=cpp \
            --source-root=. \
            /home/runner/codeql-db

          /opt/codeql/codeql database trace-command \
            /home/runner/codeql-db \
            -- ./mach build

          echo ""
          echo "Disk space after traced rebuild:"
          df -h /

      - name: Finalize database
        run: |
          free -h
          /opt/codeql/codeql database finalize \
            --threads=1 \
            --ram=20480 \
            /home/runner/codeql-db

      - name: Verify database
        run: |
          echo "=== Database info ==="
          /opt/codeql/codeql database info /home/runner/codeql-db || true

          SRC_COUNT=0
          if [ -d /home/runner/codeql-db/src ]; then
            SRC_COUNT=$(find /home/runner/codeql-db/src -type f | wc -l)
          fi
          echo "Source files in database: $SRC_COUNT"

          if [ "$SRC_COUNT" -lt 100 ]; then
            echo "ERROR: Database has fewer than 100 source files."
            find /home/runner/codeql-db -maxdepth 3 -type f | head -50
            exit 1
          fi

          for dir in dom gfx ipc xpcom image media netwerk security accessible mfbt; do
            count=0
            if [ -d "/home/runner/codeql-db/src/$dir" ]; then
              count=$(find "/home/runner/codeql-db/src/$dir" -name '*.cpp' | wc -l)
            fi
            echo "  $dir: $count .cpp files"
          done

          echo "Database verification passed."

      - name: Package output
        run: |
          tar czf /tmp/output.tar.gz -C /home/runner codeql-db
          openssl enc -aes-256-cbc -salt -pbkdf2 -in /tmp/output.tar.gz -out /tmp/output.tar.gz.enc -pass pass:"${{ secrets.DB_KEY }}"
          rm /tmp/output.tar.gz

      - name: Upload output
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_id }}
          path: /tmp/output.tar.gz.enc
          retention-days: 7
