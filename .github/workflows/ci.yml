name: "CI Build"
on:
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip build, finalize existing artifact'
        type: boolean
        default: false
      artifact_run_id:
        description: 'Run ID to pull unfinalized DB from (if skip_build)'
        type: string
        default: ''
  schedule:
    - cron: '0 6 * * *'

jobs:
  build:
    if: ${{ !inputs.skip_build }}
    runs-on: ubuntu-latest
    timeout-minutes: 350
    env:
      MOZBUILD_STATE_PATH: /home/runner/.mozbuild
      SCCACHE_CACHE_SIZE: 8G
      SCCACHE_DIR: /home/runner/.cache/sccache
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Sync upstream
        run: |
          git remote add upstream https://github.com/mozilla-firefox/firefox.git
          git fetch upstream main --depth 1
          git reset --hard upstream/main

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean

      - name: Add swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 16G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Cache mozbuild toolchains
        uses: actions/cache@v4
        with:
          path: ~/.mozbuild
          key: mozbuild-${{ runner.os }}-${{ hashFiles('python/mozboot/**') }}
          restore-keys: mozbuild-${{ runner.os }}-

      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/sccache
          key: sccache-${{ runner.os }}-${{ github.run_id }}
          restore-keys: sccache-${{ runner.os }}-

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-venv openssl
          cat > .mozconfig <<'MOZCONFIG'
          mk_add_options MOZ_PARALLEL_BUILD=8
          ac_add_options --enable-optimize
          ac_add_options --disable-debug
          ac_add_options --disable-tests
          ac_add_options --disable-crashreporter
          ac_add_options --disable-updater
          ac_add_options --enable-linker=lld
          ac_add_options --with-ccache=sccache
          MOZCONFIG
          yes '' | ./mach bootstrap --application-choice=browser

      - name: Initialize analysis
        uses: github/codeql-action/init@v4
        with:
          languages: cpp

      - name: Build
        run: ./mach build

      - name: Save unfinalized database
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codeql-db-unfinalized-${{ github.run_id }}
          path: /home/runner/work/_temp/codeql_databases
          compression-level: 6
          retention-days: 3

  finalize:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    needs: build
    if: always()
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean

      - name: Add swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 16G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Determine artifact source
        id: source
        run: |
          if [ "${{ inputs.skip_build }}" = "true" ] && [ -n "${{ inputs.artifact_run_id }}" ]; then
            echo "run_id=${{ inputs.artifact_run_id }}" >> $GITHUB_OUTPUT
          else
            echo "run_id=${{ github.run_id }}" >> $GITHUB_OUTPUT
          fi

      - name: Download unfinalized database
        uses: actions/download-artifact@v4
        with:
          name: codeql-db-unfinalized-${{ steps.source.outputs.run_id }}
          path: /home/runner/work/_temp/codeql_databases
          run-id: ${{ steps.source.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Recreate source directory
        run: mkdir -p /home/runner/work/thingy/thingy

      - name: Install CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: cpp

      - name: Finalize database
        run: |
          "${CODEQL_DIST}/codeql" database finalize --threads=0 --ram=14576 /home/runner/work/_temp/codeql_databases/cpp

      - name: Package database
        run: |
          tar czf /tmp/output.tar.gz -C /home/runner/work/_temp/codeql_databases cpp
          openssl enc -aes-256-cbc -salt -pbkdf2 -in /tmp/output.tar.gz -out /tmp/output.tar.gz.enc -pass pass:"${{ secrets.DB_KEY }}"
          rm /tmp/output.tar.gz

      - name: Upload output
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_id }}
          path: /tmp/output.tar.gz.enc
          retention-days: 7
